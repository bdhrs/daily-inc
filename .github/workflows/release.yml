name: Release Build

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.versioning.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Calculate Version
        id: versioning
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          TAG_VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $TAG_VERSION | cut -d. -f1)
          MINOR=$(echo $TAG_VERSION | cut -d. -f2)
          PATCH=$(echo $TAG_VERSION | cut -d. -f3)
          NEW_PATCH=$((PATCH + 1))
          VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "Latest release tag: $LATEST_TAG"
          echo "New version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

  test:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - run: flutter pub get
      - run: flutter analyze
      - run: flutter test

  build-android:
    needs: [prepare, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - run: flutter pub get
      - name: Setup Android Signing
        env:
          KEY_JKS: ${{ secrets.KEY_JKS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ALIAS_PASSWORD: ${{ secrets.ALIAS_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "$KEY_JKS" | base64 --decode > android/app/release.keystore
          echo "storeFile=release.keystore" > android/key.properties
          echo "storePassword=$KEY_PASSWORD" >> android/key.properties
          echo "keyPassword=$ALIAS_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
      - name: Build APK
        run: |
          flutter build apk --release --build-name=${{ needs.prepare.outputs.VERSION }} --build-number=${{ github.run_number }}
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/daily-inc-v${{ needs.prepare.outputs.VERSION }}.apk
      - uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: build/app/outputs/flutter-apk/daily-inc-v${{ needs.prepare.outputs.VERSION }}.apk

  build-linux:
    needs: [prepare, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Linux dependencies
        run: sudo apt update && sudo apt install -y libgtk-3-dev pkg-config libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev zip
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      - run: flutter pub get
      - name: Build Linux Bundle
        run: |
          flutter build linux --release --build-name=${{ needs.prepare.outputs.VERSION }} --build-number=${{ github.run_number }}
          cd build/linux/x64/release/bundle
          zip -r daily-inc-v${{ needs.prepare.outputs.VERSION }}-linux.zip .
      - uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: build/linux/x64/release/bundle/daily-inc-v${{ needs.prepare.outputs.VERSION }}-linux.zip

  publish-release:
    needs: [prepare, build-android, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/download-artifact@v4
        with:
          name: android-release
          path: artifacts/android
      - uses: actions/download-artifact@v4
        with:
          name: linux-release
          path: artifacts/linux
      - name: Generate Changelog
        id: changelog
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $LATEST_TAG..HEAD | grep -v "^- chore:" | tac)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" | tac)
          fi
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Daily Inc v${{ needs.prepare.outputs.VERSION }}
          tag_name: v${{ needs.prepare.outputs.VERSION }}
          body: "${{ steps.changelog.outputs.CHANGELOG }}"
          files: |
            artifacts/android/*.apk
            artifacts/linux/*.zip
